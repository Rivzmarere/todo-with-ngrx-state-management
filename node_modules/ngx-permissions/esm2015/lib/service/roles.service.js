import { Inject, Injectable, InjectionToken } from '@angular/core';
import { BehaviorSubject, from, of } from 'rxjs';
import { catchError, every, first, map, mergeAll, mergeMap, switchMap } from 'rxjs/operators';
import { NgxRolesStore } from '../store/roles.store';
import { isBoolean, isFunction, isPromise, transformStringToArray } from '../utils/utils';
import { NgxPermissionsService } from './permissions.service';
export const USE_ROLES_STORE = new InjectionToken('USE_ROLES_STORE');
export class NgxRolesService {
    constructor(isolate = false, rolesStore, permissionsService) {
        this.isolate = isolate;
        this.rolesStore = rolesStore;
        this.permissionsService = permissionsService;
        this.rolesSource = this.isolate ? new BehaviorSubject({}) : this.rolesStore.rolesSource;
        this.roles$ = this.rolesSource.asObservable();
    }
    addRole(name, validationFunction) {
        const roles = Object.assign(Object.assign({}, this.rolesSource.value), { [name]: { name, validationFunction } });
        this.rolesSource.next(roles);
    }
    addRoleWithPermissions(name, permissions) {
        this.permissionsService.addPermission(permissions);
        this.addRole(name, permissions);
    }
    addRoles(rolesObj) {
        Object.keys(rolesObj).forEach((key, index) => {
            this.addRole(key, rolesObj[key]);
        });
    }
    addRolesWithPermissions(rolesObj) {
        Object.keys(rolesObj).forEach((key, index) => {
            this.addRoleWithPermissions(key, rolesObj[key]);
        });
    }
    flushRoles() {
        this.rolesSource.next({});
    }
    flushRolesAndPermissions() {
        this.flushRoles();
        this.permissionsService.flushPermissions();
    }
    removeRole(roleName) {
        const roles = Object.assign({}, this.rolesSource.value);
        delete roles[roleName];
        this.rolesSource.next(roles);
    }
    getRoles() {
        return this.rolesSource.value;
    }
    getRole(name) {
        return this.rolesSource.value[name];
    }
    hasOnlyRoles(names) {
        const isNamesEmpty = !names || (Array.isArray(names) && names.length === 0);
        if (isNamesEmpty) {
            return Promise.resolve(true);
        }
        names = transformStringToArray(names);
        return Promise.all([this.hasRoleKey(names), this.hasRolePermission(this.rolesSource.value, names)])
            .then(([hasRoles, hasPermissions]) => {
            return hasRoles || hasPermissions;
        });
    }
    hasRoleKey(roleName) {
        const promises = roleName.map((key) => {
            const hasValidationFunction = !!this.rolesSource.value[key] &&
                !!this.rolesSource.value[key].validationFunction &&
                isFunction(this.rolesSource.value[key].validationFunction);
            if (hasValidationFunction && !isPromise(this.rolesSource.value[key].validationFunction)) {
                const validationFunction = this.rolesSource.value[key].validationFunction;
                const immutableValue = Object.assign({}, this.rolesSource.value);
                return of(null).pipe(map(() => validationFunction(key, immutableValue)), switchMap((promise) => isBoolean(promise) ?
                    of(promise) : promise), catchError(() => of(false)));
            }
            return of(false);
        });
        return from(promises).pipe(mergeAll(), first((data) => data !== false, false), map((data) => data !== false)).toPromise().then((data) => data);
    }
    hasRolePermission(roles, roleNames) {
        return from(roleNames).pipe(mergeMap((key) => {
            if (roles[key] && Array.isArray(roles[key].validationFunction)) {
                return from(roles[key].validationFunction).pipe(mergeMap((permission) => this.permissionsService.hasPermission(permission)), every(hasPermission => hasPermission === true));
            }
            return of(false);
        }), first(hasPermission => hasPermission === true, false)).toPromise();
    }
}
NgxRolesService.decorators = [
    { type: Injectable }
];
NgxRolesService.ctorParameters = () => [
    { type: Boolean, decorators: [{ type: Inject, args: [USE_ROLES_STORE,] }] },
    { type: NgxRolesStore },
    { type: NgxPermissionsService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3NlcnZpY2Uvcm9sZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQStCLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RSxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJOUYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzFGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTlELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyxJQUFJLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBT3JFLE1BQU0sT0FBTyxlQUFlO0lBTXhCLFlBQ3FDLFVBQW1CLEtBQUssRUFDakQsVUFBeUIsRUFDekIsa0JBQXlDO1FBRmhCLFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBQ2pELGVBQVUsR0FBVixVQUFVLENBQWU7UUFDekIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUF1QjtRQUVqRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksZUFBZSxDQUFpQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFD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QTNISixVQUFVOzs7MENBUUYsTUFBTSxTQUFDLGVBQWU7WUFsQnRCLGFBQWE7WUFFYixxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZUlucHV0LCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZXZlcnksIGZpcnN0LCBtYXAsIG1lcmdlQWxsLCBtZXJnZU1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkZuIH0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbnMtcm91dGVyLWRhdGEubW9kZWwnO1xuXG5pbXBvcnQgeyBOZ3hSb2xlIH0gZnJvbSAnLi4vbW9kZWwvcm9sZS5tb2RlbCc7XG5pbXBvcnQgeyBOZ3hSb2xlc1N0b3JlIH0gZnJvbSAnLi4vc3RvcmUvcm9sZXMuc3RvcmUnO1xuaW1wb3J0IHsgaXNCb29sZWFuLCBpc0Z1bmN0aW9uLCBpc1Byb21pc2UsIHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc1NlcnZpY2UgfSBmcm9tICcuL3Blcm1pc3Npb25zLnNlcnZpY2UnO1xuXG5leHBvcnQgY29uc3QgVVNFX1JPTEVTX1NUT1JFID0gbmV3IEluamVjdGlvblRva2VuKCdVU0VfUk9MRVNfU1RPUkUnKTtcblxuZXhwb3J0IGludGVyZmFjZSBOZ3hSb2xlc09iamVjdCB7XG4gICAgW25hbWU6IHN0cmluZ106IE5neFJvbGU7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ3hSb2xlc1NlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSByb2xlc1NvdXJjZTogQmVoYXZpb3JTdWJqZWN0PE5neFJvbGVzT2JqZWN0PjtcblxuICAgIHB1YmxpYyByb2xlcyQ6IE9ic2VydmFibGU8Tmd4Um9sZXNPYmplY3Q+O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoVVNFX1JPTEVTX1NUT1JFKSBwcml2YXRlIGlzb2xhdGU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICAgICAgcHJpdmF0ZSByb2xlc1N0b3JlOiBOZ3hSb2xlc1N0b3JlLFxuICAgICAgICBwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHRoaXMucm9sZXNTb3VyY2UgPSB0aGlzLmlzb2xhdGUgPyBuZXcgQmVoYXZpb3JTdWJqZWN0PE5neFJvbGVzT2JqZWN0Pih7fSkgOiB0aGlzLnJvbGVzU3RvcmUucm9sZXNTb3VyY2U7XG4gICAgICAgIHRoaXMucm9sZXMkID0gdGhpcy5yb2xlc1NvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkUm9sZShuYW1lOiBzdHJpbmcsIHZhbGlkYXRpb25GdW5jdGlvbjogVmFsaWRhdGlvbkZuIHwgc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3Qgcm9sZXMgPSB7XG4gICAgICAgICAgICAuLi50aGlzLnJvbGVzU291cmNlLnZhbHVlLFxuICAgICAgICAgICAgW25hbWVdOiB7bmFtZSwgdmFsaWRhdGlvbkZ1bmN0aW9ufVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnJvbGVzU291cmNlLm5leHQocm9sZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRSb2xlV2l0aFBlcm1pc3Npb25zKG5hbWU6IHN0cmluZywgcGVybWlzc2lvbnM6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmFkZFBlcm1pc3Npb24ocGVybWlzc2lvbnMpO1xuICAgICAgICB0aGlzLmFkZFJvbGUobmFtZSwgcGVybWlzc2lvbnMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRSb2xlcyhyb2xlc09iajogeyBbbmFtZTogc3RyaW5nXTogVmFsaWRhdGlvbkZuIHwgc3RyaW5nW10gfSkge1xuICAgICAgICBPYmplY3Qua2V5cyhyb2xlc09iaikuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hZGRSb2xlKGtleSwgcm9sZXNPYmpba2V5XSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRSb2xlc1dpdGhQZXJtaXNzaW9ucyhyb2xlc09iajogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nW10gfSkge1xuICAgICAgICBPYmplY3Qua2V5cyhyb2xlc09iaikuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hZGRSb2xlV2l0aFBlcm1pc3Npb25zKGtleSwgcm9sZXNPYmpba2V5XSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmbHVzaFJvbGVzKCkge1xuICAgICAgICB0aGlzLnJvbGVzU291cmNlLm5leHQoe30pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmbHVzaFJvbGVzQW5kUGVybWlzc2lvbnMoKSB7XG4gICAgICAgIHRoaXMuZmx1c2hSb2xlcygpO1xuICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5mbHVzaFBlcm1pc3Npb25zKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZVJvbGUocm9sZU5hbWU6IHN0cmluZykge1xuICAgICAgICBjb25zdCByb2xlcyA9IHtcbiAgICAgICAgICAgIC4uLnRoaXMucm9sZXNTb3VyY2UudmFsdWVcbiAgICAgICAgfTtcbiAgICAgICAgZGVsZXRlIHJvbGVzW3JvbGVOYW1lXTtcbiAgICAgICAgdGhpcy5yb2xlc1NvdXJjZS5uZXh0KHJvbGVzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Um9sZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJvbGVzU291cmNlLnZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRSb2xlKG5hbWU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5yb2xlc1NvdXJjZS52YWx1ZVtuYW1lXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaGFzT25seVJvbGVzKG5hbWVzOiBzdHJpbmcgfCBzdHJpbmdbXSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBpc05hbWVzRW1wdHkgPSAhbmFtZXMgfHwgKEFycmF5LmlzQXJyYXkobmFtZXMpICYmIG5hbWVzLmxlbmd0aCA9PT0gMCk7XG5cbiAgICAgICAgaWYgKGlzTmFtZXNFbXB0eSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5hbWVzID0gdHJhbnNmb3JtU3RyaW5nVG9BcnJheShuYW1lcyk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFt0aGlzLmhhc1JvbGVLZXkobmFtZXMpLCB0aGlzLmhhc1JvbGVQZXJtaXNzaW9uKHRoaXMucm9sZXNTb3VyY2UudmFsdWUsIG5hbWVzKV0pXG4gICAgICAgICAgICAudGhlbigoW2hhc1JvbGVzLCBoYXNQZXJtaXNzaW9uc106IFtib29sZWFuLCBib29sZWFuXSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBoYXNSb2xlcyB8fCBoYXNQZXJtaXNzaW9ucztcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzUm9sZUtleShyb2xlTmFtZTogc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgcHJvbWlzZXM6IE9ic2VydmFibGU8Ym9vbGVhbj5bXSA9IHJvbGVOYW1lLm1hcCgoa2V5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBoYXNWYWxpZGF0aW9uRnVuY3Rpb24gPSAhIXRoaXMucm9sZXNTb3VyY2UudmFsdWVba2V5XSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgISF0aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0Z1bmN0aW9uKHRoaXMucm9sZXNTb3VyY2UudmFsdWVba2V5XS52YWxpZGF0aW9uRnVuY3Rpb24pO1xuXG4gICAgICAgICAgICBpZiAoaGFzVmFsaWRhdGlvbkZ1bmN0aW9uICYmICFpc1Byb21pc2UodGhpcy5yb2xlc1NvdXJjZS52YWx1ZVtrZXldLnZhbGlkYXRpb25GdW5jdGlvbikpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0aW9uRnVuY3Rpb24gPSB0aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uIGFzIFZhbGlkYXRpb25GbjtcbiAgICAgICAgICAgICAgICBjb25zdCBpbW11dGFibGVWYWx1ZSA9IHsuLi50aGlzLnJvbGVzU291cmNlLnZhbHVlfTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBvZihudWxsKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoKCkgPT4gdmFsaWRhdGlvbkZ1bmN0aW9uKGtleSwgaW1tdXRhYmxlVmFsdWUpKSxcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKChwcm9taXNlOiBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbik6IE9ic2VydmFibGVJbnB1dDxib29sZWFuPiA9PiBpc0Jvb2xlYW4ocHJvbWlzZSkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgb2YocHJvbWlzZSBhcyBib29sZWFuKSA6IHByb21pc2UgYXMgUHJvbWlzZTxib29sZWFuPiksXG4gICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2YoZmFsc2UpKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBmcm9tKHByb21pc2VzKS5waXBlKFxuICAgICAgICAgICAgbWVyZ2VBbGwoKSxcbiAgICAgICAgICAgIGZpcnN0KChkYXRhOiBhbnkpID0+IGRhdGEgIT09IGZhbHNlLCBmYWxzZSksXG4gICAgICAgICAgICBtYXAoKGRhdGEpID0+IGRhdGEgIT09IGZhbHNlKVxuICAgICAgICApLnRvUHJvbWlzZSgpLnRoZW4oKGRhdGE6IGFueSkgPT4gZGF0YSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNSb2xlUGVybWlzc2lvbihyb2xlczogTmd4Um9sZXNPYmplY3QsIHJvbGVOYW1lczogc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIGZyb20ocm9sZU5hbWVzKS5waXBlKFxuICAgICAgICAgICAgbWVyZ2VNYXAoKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyb2xlc1trZXldICYmIEFycmF5LmlzQXJyYXkocm9sZXNba2V5XS52YWxpZGF0aW9uRnVuY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmcm9tKHJvbGVzW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VNYXAoKHBlcm1pc3Npb24pID0+IHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbikpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlKVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGZpcnN0KGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gdHJ1ZSwgZmFsc2UpXG4gICAgICAgICkudG9Qcm9taXNlKCk7XG4gICAgfVxuXG59XG4iXX0=