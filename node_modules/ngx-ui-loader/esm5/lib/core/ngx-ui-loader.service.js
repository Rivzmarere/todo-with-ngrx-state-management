import { __assign, __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, Optional } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { BACKGROUND, CLOSING_TIME, DEFAULT_BG_TASK_ID, DEFAULT_CONFIG, DEFAULT_FG_TASK_ID, DEFAULT_TIME, FAST_CLOSING_TIME, FOREGROUND, MIN_DELAY, MIN_TIME, OVERLAY_DISAPPEAR_TIME, FAST_OVERLAY_DISAPPEAR_TIME } from '../utils/constants';
import { NGX_UI_LOADER_CONFIG_TOKEN } from './ngx-ui-loader-config.token';
import * as i0 from "@angular/core";
import * as i1 from "./ngx-ui-loader-config.token";
var NgxUiLoaderService = /** @class */ (function () {
    /**
     * Constructor
     */
    function NgxUiLoaderService(config) {
        this.config = config;
        this.defaultConfig = __assign({}, DEFAULT_CONFIG);
        if (this.config) {
            if (this.config.minTime && this.config.minTime < MIN_TIME) {
                this.config.minTime = MIN_TIME;
            }
            this.defaultConfig = __assign(__assign({}, this.defaultConfig), this.config);
        }
        this.loaders = {};
        this.showForeground = new BehaviorSubject({ loaderId: '', isShow: false });
        this.showForeground$ = this.showForeground.asObservable();
        this.showBackground = new BehaviorSubject({ loaderId: '', isShow: false });
        this.showBackground$ = this.showBackground.asObservable();
        this.fgClosing = new BehaviorSubject({ loaderId: '', isShow: false });
        this.foregroundClosing$ = this.fgClosing.asObservable();
        this.bgClosing = new BehaviorSubject({ loaderId: '', isShow: false });
        this.backgroundClosing$ = this.bgClosing.asObservable();
    }
    /**
     * For internal use only.
     * @docs-private
     */
    NgxUiLoaderService.prototype.bindLoaderData = function (loaderId) {
        var isMaster = loaderId === this.defaultConfig.masterLoaderId;
        if (this.loaders[loaderId]) {
            if (this.loaders[loaderId].isBound) {
                throw new Error("[ngx-ui-loader] - loaderId \"" + loaderId + "\" is duplicated.");
            }
            this.loaders[loaderId].isBound = true;
            this.loaders[loaderId].isMaster = isMaster;
            // emit showEvent after data loader is bound
            if (this.hasRunningTask(FOREGROUND, loaderId)) {
                this.showForeground.next({ loaderId: loaderId, isShow: true });
            }
            else {
                if (this.hasRunningTask(BACKGROUND, loaderId)) {
                    this.showBackground.next({ loaderId: loaderId, isShow: true });
                }
            }
        }
        else {
            this.createLoaderData(loaderId, isMaster, true);
        }
    };
    /**
     * For internal use only.
     * @docs-private
     */
    NgxUiLoaderService.prototype.destroyLoaderData = function (loaderId) {
        this.stopAllLoader(loaderId);
        delete this.loaders[loaderId];
    };
    /**
     * Get default loader configuration
     * @returns default configuration object
     */
    NgxUiLoaderService.prototype.getDefaultConfig = function () {
        return __assign({}, this.defaultConfig);
    };
    /**
     * Get all the loaders
     */
    NgxUiLoaderService.prototype.getLoaders = function () {
        return JSON.parse(JSON.stringify(this.loaders));
    };
    /**
     * Get data of a specified loader. If loaderId is not provided, it will return data of
     * master loader(if existed). Otherwise null is returned.
     */
    NgxUiLoaderService.prototype.getLoader = function (loaderId) {
        loaderId = loaderId ? loaderId : this.defaultConfig.masterLoaderId;
        if (this.loaders[loaderId]) {
            return JSON.parse(JSON.stringify(this.loaders[loaderId]));
        }
        return null;
    };
    /**
     * Start the foreground loading of loader having `loaderId` with a specified `taskId`.
     * The loading is only closed off when all taskIds of that loader are called with stopLoader() method.
     * @param loaderId the loader Id
     * @param taskId the optional task Id of the loading. taskId is set to 'fd-default' by default.
     */
    NgxUiLoaderService.prototype.startLoader = function (loaderId, taskId, time) {
        if (taskId === void 0) { taskId = DEFAULT_FG_TASK_ID; }
        if (!this.readyToStart(loaderId, taskId, true, time)) {
            return;
        }
        if (!this.loaders[loaderId].tasks[taskId].isOtherRunning) {
            // no other foreground task running
            if (this.hasRunningTask(BACKGROUND, loaderId)) {
                this.backgroundCloseout(loaderId);
                this.showBackground.next({ loaderId: loaderId, isShow: false });
            }
            this.showForeground.next({ loaderId: loaderId, isShow: true });
        }
    };
    /**
     * Start the foreground loading of master loader with a specified `taskId`.
     * The loading is only closed off when all taskIds of that loader are called with stop() method.
     * NOTE: Really this function just wraps startLoader() function
     * @param taskId the optional task Id of the loading. taskId is set to 'fd-default' by default.
     */
    NgxUiLoaderService.prototype.start = function (taskId, time) {
        if (taskId === void 0) { taskId = DEFAULT_FG_TASK_ID; }
        this.startLoader(this.defaultConfig.masterLoaderId, taskId, time);
    };
    /**
     * Start the background loading of loader having `loaderId` with a specified `taskId`.
     * The loading is only closed off when all taskIds of that loader are called with stopLoaderBackground() method.
     * @param loaderId the loader Id
     * @param taskId the optional task Id of the loading. taskId is set to 'bg-default' by default.
     */
    NgxUiLoaderService.prototype.startBackgroundLoader = function (loaderId, taskId, time) {
        if (taskId === void 0) { taskId = DEFAULT_BG_TASK_ID; }
        if (!this.readyToStart(loaderId, taskId, false, time)) {
            return;
        }
        if (!this.hasRunningTask(FOREGROUND, loaderId) && !this.loaders[loaderId].tasks[taskId].isOtherRunning) {
            this.showBackground.next({ loaderId: loaderId, isShow: true });
        }
    };
    /**
     * Start the background loading of master loader with a specified `taskId`.
     * The loading is only closed off when all taskIds of that loader are called with stopBackground() method.
     * NOTE: Really this function just wraps startBackgroundLoader() function
     * @param taskId the optional task Id of the loading. taskId is set to 'bg-default' by default.
     */
    NgxUiLoaderService.prototype.startBackground = function (taskId, time) {
        if (taskId === void 0) { taskId = DEFAULT_BG_TASK_ID; }
        this.startBackgroundLoader(this.defaultConfig.masterLoaderId, taskId, time);
    };
    /**
     * Stop a foreground loading of loader having `loaderId` with specific `taskId`
     * @param loaderId the loader Id
     * @param taskId the optional task Id to stop. If not provided, 'fg-default' is used.
     * @returns Object
     */
    NgxUiLoaderService.prototype.stopLoader = function (loaderId, taskId) {
        var _this = this;
        if (taskId === void 0) { taskId = DEFAULT_FG_TASK_ID; }
        if (!this.readyToStop(loaderId, taskId)) {
            return;
        }
        if (!this.hasRunningTask(FOREGROUND, loaderId)) {
            this.foregroundCloseout(loaderId);
            this.showForeground.next({ loaderId: loaderId, isShow: false });
            if (this.hasRunningTask(BACKGROUND, loaderId)) {
                setTimeout(function () {
                    if (_this.hasRunningTask(BACKGROUND, loaderId)) {
                        // still have background tasks
                        _this.showBackground.next({ loaderId: loaderId, isShow: true });
                    }
                }, this.defaultConfig.fastFadeOut ? FAST_OVERLAY_DISAPPEAR_TIME : OVERLAY_DISAPPEAR_TIME);
            }
        }
    };
    /**
     * Stop a foreground loading of master loader with specific `taskId`
     * @param taskId the optional task Id to stop. If not provided, 'fg-default' is used.
     * @returns Object
     */
    NgxUiLoaderService.prototype.stop = function (taskId) {
        if (taskId === void 0) { taskId = DEFAULT_FG_TASK_ID; }
        this.stopLoader(this.defaultConfig.masterLoaderId, taskId);
    };
    /**
     * Stop a background loading of loader having `loaderId` with specific `taskId`
     * @param loaderId the loader Id
     * @param taskId the optional task Id to stop. If not provided, 'bg-default' is used.
     * @returns Object
     */
    NgxUiLoaderService.prototype.stopBackgroundLoader = function (loaderId, taskId) {
        if (taskId === void 0) { taskId = DEFAULT_BG_TASK_ID; }
        if (!this.readyToStop(loaderId, taskId)) {
            return;
        }
        if (!this.hasRunningTask(FOREGROUND, loaderId) && !this.hasRunningTask(BACKGROUND, loaderId)) {
            this.backgroundCloseout(loaderId);
            this.showBackground.next({ loaderId: loaderId, isShow: false });
        }
    };
    /**
     * Stop a background loading of master loader with specific taskId
     * @param taskId the optional task Id to stop. If not provided, 'bg-default' is used.
     * @returns Object
     */
    NgxUiLoaderService.prototype.stopBackground = function (taskId) {
        if (taskId === void 0) { taskId = DEFAULT_BG_TASK_ID; }
        this.stopBackgroundLoader(this.defaultConfig.masterLoaderId, taskId);
    };
    /**
     * Stop all the background and foreground loadings of loader having `loaderId`
     * @param loaderId the loader Id
     */
    NgxUiLoaderService.prototype.stopAllLoader = function (loaderId) {
        if (!this.loaders[loaderId]) {
            console.warn("[ngx-ui-loader] - loaderId \"" + loaderId + "\" does not exist.");
            return;
        }
        if (this.hasRunningTask(FOREGROUND, loaderId)) {
            this.foregroundCloseout(loaderId);
            this.showForeground.next({ loaderId: loaderId, isShow: false });
        }
        else if (this.hasRunningTask(BACKGROUND, loaderId)) {
            this.backgroundCloseout(loaderId);
            this.showBackground.next({ loaderId: loaderId, isShow: false });
        }
        this.clearAllTimers(this.loaders[loaderId].tasks);
        this.loaders[loaderId].tasks = {};
    };
    /**
     * Stop all the background and foreground loadings of master loader
     */
    NgxUiLoaderService.prototype.stopAll = function () {
        this.stopAllLoader(this.defaultConfig.masterLoaderId);
    };
    /**
     * Create loader data if it does not exist
     * @docs-private
     */
    NgxUiLoaderService.prototype.createLoaderData = function (loaderId, isMaster, isBound) {
        if (!this.loaders[loaderId]) {
            this.loaders[loaderId] = {
                loaderId: loaderId,
                tasks: {},
                isMaster: isMaster,
                isBound: isBound
            };
        }
    };
    /**
     * Manage to close foreground loading
     * @docs-private
     * @param loaderId the loader id
     */
    NgxUiLoaderService.prototype.foregroundCloseout = function (loaderId) {
        var _this = this;
        this.fgClosing.next({ loaderId: loaderId, isShow: true });
        setTimeout(function () {
            _this.fgClosing.next({ loaderId: loaderId, isShow: false });
        }, this.defaultConfig.fastFadeOut ? FAST_CLOSING_TIME : CLOSING_TIME);
    };
    /**
     * Manage to close background loading
     * @docs-private
     * @param loaderId the loader id
     */
    NgxUiLoaderService.prototype.backgroundCloseout = function (loaderId) {
        var _this = this;
        this.bgClosing.next({ loaderId: loaderId, isShow: true });
        setTimeout(function () {
            _this.bgClosing.next({ loaderId: loaderId, isShow: false });
        }, this.defaultConfig.fastFadeOut ? FAST_CLOSING_TIME : CLOSING_TIME);
    };
    /**
     * Clear all timers of the given task
     * @docs-private
     */
    NgxUiLoaderService.prototype.clearTimers = function (task) {
        clearTimeout(task.delayTimer);
        clearTimeout(task.maxTimer);
        clearTimeout(task.minTimer);
    };
    /**
     * Clear all timers of the given tasks
     * @docs-private
     */
    NgxUiLoaderService.prototype.clearAllTimers = function (tasks) {
        var _this = this;
        Object.keys(tasks).map(function (id) {
            _this.clearTimers(tasks[id]);
        });
    };
    /**
     * Check whether the specified loader has a running task with the given `taskId`.
     * If no `taskId` specified, it will check whether the loader has any running tasks.
     * For internal use only.
     * @docs-private
     * @param isForeground foreground task or background task
     * @param loaderId the loader Id
     * @param taskId the optional task Id
     * @returns boolean
     */
    NgxUiLoaderService.prototype.hasRunningTask = function (isForeground, loaderId, taskId) {
        if (this.loaders[loaderId]) {
            var tasks_1 = this.loaders[loaderId].tasks;
            if (taskId) {
                return tasks_1[taskId] ? (tasks_1[taskId].startAt ? true : false) : false;
            }
            return Object.keys(tasks_1).some(function (id) { return !!tasks_1[id].startAt && tasks_1[id].isForeground === isForeground; });
        }
        return false;
    };
    /**
     * @docs-private
     */
    NgxUiLoaderService.prototype.readyToStart = function (loaderId, taskId, isForeground, time) {
        if (time === void 0) { time = DEFAULT_TIME; }
        this.createLoaderData(loaderId, undefined, false);
        var isOtherRunning = this.hasRunningTask(isForeground, loaderId);
        if (!this.loaders[loaderId].tasks[taskId]) {
            this.loaders[loaderId].tasks[taskId] = {
                taskId: taskId,
                isForeground: isForeground,
                minTime: time.minTime >= MIN_TIME ? time.minTime : this.defaultConfig.minTime,
                maxTime: time.maxTime ? time.maxTime : this.defaultConfig.maxTime,
                delay: time.delay >= MIN_DELAY ? time.delay : this.defaultConfig.delay
            };
        }
        else {
            if (this.loaders[loaderId].tasks[taskId].isForeground !== isForeground) {
                throw new Error("[ngx-ui-loader] - taskId \"" + taskId + "\" is duplicated.");
            }
        }
        if (this.setDelayTimer(this.loaders[loaderId].tasks[taskId], loaderId)) {
            return false;
        }
        this.loaders[loaderId].tasks[taskId] = __assign(__assign({}, this.loaders[loaderId].tasks[taskId]), { isOtherRunning: isOtherRunning, startAt: Date.now() });
        this.setMaxTimer(this.loaders[loaderId].tasks[taskId], loaderId);
        if (!this.loaders[loaderId].isBound) {
            return false;
        }
        return true;
    };
    /**
     * @docs-private
     */
    NgxUiLoaderService.prototype.readyToStop = function (loaderId, taskId) {
        if (!this.loaders[loaderId]) {
            console.warn("[ngx-ui-loader] - loaderId \"" + loaderId + "\" does not exist.");
            return false;
        }
        var task = this.loaders[loaderId].tasks[taskId];
        if (!task) {
            return false;
        }
        if (task.isDelayed) {
            this.clearTimers(task);
            delete this.loaders[loaderId].tasks[taskId];
            return false;
        }
        if (this.setMinTimer(task, loaderId)) {
            return false;
        }
        this.clearTimers(task);
        delete this.loaders[loaderId].tasks[taskId];
        return true;
    };
    /**
     * Set delay timer, if `delay` > 0
     * @docs-private
     * @returns boolean
     */
    NgxUiLoaderService.prototype.setDelayTimer = function (task, loaderId) {
        var _this = this;
        if (task.delay > MIN_DELAY) {
            if (task.isDelayed) {
                return true;
            }
            if (!task.delayTimer) {
                task.isDelayed = true;
                task.delayTimer = setTimeout(function () {
                    task.isDelayed = false;
                    if (task.isForeground) {
                        _this.startLoader(loaderId, task.taskId);
                    }
                    else {
                        _this.startBackgroundLoader(loaderId, task.taskId);
                    }
                }, task.delay);
                return true;
            }
        }
        return false;
    };
    /**
     * Set maxTimer if `maxTime` > `minTime`
     * @docs-private
     * @returns boolean
     */
    NgxUiLoaderService.prototype.setMaxTimer = function (task, loaderId) {
        var _this = this;
        if (task.maxTime > task.minTime) {
            // restart the task, reset maxTimer
            clearTimeout(task.maxTimer);
            task.maxTimer = setTimeout(function () {
                if (task.isForeground) {
                    _this.stopLoader(loaderId, task.taskId);
                }
                else {
                    _this.stopBackgroundLoader(loaderId, task.taskId);
                }
            }, task.maxTime);
        }
    };
    /**
     * Set minTimer if `startAt` + `minTime` > `Date.now()`
     * @docs-private
     * @returns boolean
     */
    NgxUiLoaderService.prototype.setMinTimer = function (task, loaderId) {
        var _this = this;
        var now = Date.now();
        if (task.startAt) {
            if (task.startAt + task.minTime > now) {
                task.minTimer = setTimeout(function () {
                    if (task.isForeground) {
                        _this.stopLoader(loaderId, task.taskId);
                    }
                    else {
                        _this.stopBackgroundLoader(loaderId, task.taskId);
                    }
                }, task.startAt + task.minTime - now);
                return true;
            }
        }
        return false;
    };
    NgxUiLoaderService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [NGX_UI_LOADER_CONFIG_TOKEN,] }] }
    ]; };
    NgxUiLoaderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NgxUiLoaderService_Factory() { return new NgxUiLoaderService(i0.ɵɵinject(i1.NGX_UI_LOADER_CONFIG_TOKEN, 8)); }, token: NgxUiLoaderService, providedIn: "root" });
    NgxUiLoaderService = __decorate([
        Injectable({
            providedIn: 'root'
        }),
        __param(0, Optional()), __param(0, Inject(NGX_UI_LOADER_CONFIG_TOKEN)),
        __metadata("design:paramtypes", [Object])
    ], NgxUiLoaderService);
    return NgxUiLoaderService;
}());
export { NgxUiLoaderService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXVpLWxvYWRlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXVpLWxvYWRlci8iLCJzb3VyY2VzIjpbImxpYi9jb3JlL25neC11aS1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFFbkQsT0FBTyxFQUNMLFVBQVUsRUFDVixZQUFZLEVBQ1osa0JBQWtCLEVBQ2xCLGNBQWMsRUFDZCxrQkFBa0IsRUFDbEIsWUFBWSxFQUNaLGlCQUFpQixFQUNqQixVQUFVLEVBQ1YsU0FBUyxFQUNULFFBQVEsRUFDUixzQkFBc0IsRUFDdEIsMkJBQTJCLEVBQzVCLE1BQU0sb0JBQW9CLENBQUM7QUFDNUIsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sOEJBQThCLENBQUM7OztBQU8xRTtJQWdDRTs7T0FFRztJQUNILDRCQUFvRSxNQUF5QjtRQUF6QixXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUMzRixJQUFJLENBQUMsYUFBYSxnQkFBUSxjQUFjLENBQUUsQ0FBQztRQUMzQyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDZixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxHQUFHLFFBQVEsRUFBRTtnQkFDekQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDO2FBQ2hDO1lBQ0QsSUFBSSxDQUFDLGFBQWEseUJBQVEsSUFBSSxDQUFDLGFBQWEsR0FBSyxJQUFJLENBQUMsTUFBTSxDQUFFLENBQUM7U0FDaEU7UUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksZUFBZSxDQUFZLEVBQUUsUUFB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QUcsR0FBRyxFQUFFO2dCQUNyQyxJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztvQkFDekIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO3dCQUNyQixLQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7cUJBQ3hDO3lCQUFNO3dCQUNMLEtBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3FCQUNsRDtnQkFDSCxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDO2dCQUN0QyxPQUFPLElBQUksQ0FBQzthQUNiO1NBQ0Y7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O2dEQWpiWSxRQUFRLFlBQUksTUFBTSxTQUFDLDBCQUEwQjs7O0lBbkMvQyxrQkFBa0I7UUFIOUIsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQztRQW9DYSxXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxNQUFNLENBQUMsMEJBQTBCLENBQUMsQ0FBQTs7T0FuQ2hELGtCQUFrQixDQXFkOUI7NkJBN2VEO0NBNmVDLEFBcmRELElBcWRDO1NBcmRZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICBCQUNLR1JPVU5ELFxuICBDTE9TSU5HX1RJTUUsXG4gIERFRkFVTFRfQkdfVEFTS19JRCxcbiAgREVGQVVMVF9DT05GSUcsXG4gIERFRkFVTFRfRkdfVEFTS19JRCxcbiAgREVGQVVMVF9USU1FLFxuICBGQVNUX0NMT1NJTkdfVElNRSxcbiAgRk9SRUdST1VORCxcbiAgTUlOX0RFTEFZLFxuICBNSU5fVElNRSxcbiAgT1ZFUkxBWV9ESVNBUFBFQVJfVElNRSxcbiAgRkFTVF9PVkVSTEFZX0RJU0FQUEVBUl9USU1FXG59IGZyb20gJy4uL3V0aWxzL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBOR1hfVUlfTE9BREVSX0NPTkZJR19UT0tFTiB9IGZyb20gJy4vbmd4LXVpLWxvYWRlci1jb25maWcudG9rZW4nO1xuaW1wb3J0IHsgTmd4VWlMb2FkZXJDb25maWcgfSBmcm9tICcuLi91dGlscy9pbnRlcmZhY2VzJztcbmltcG9ydCB7IExvYWRlcnMsIExvYWRlciwgU2hvd0V2ZW50LCBUYXNrcywgVGFzaywgVGltZSB9IGZyb20gJy4uL3V0aWxzL2ludGVyZmFjZXMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBOZ3hVaUxvYWRlclNlcnZpY2Uge1xuICAvKipcbiAgICogRm9yIGludGVybmFsIHVzZSBvbmx5LlxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqL1xuICBiYWNrZ3JvdW5kQ2xvc2luZyQ6IE9ic2VydmFibGU8U2hvd0V2ZW50PjtcblxuICAvKipcbiAgICogRm9yIGludGVybmFsIHVzZSBvbmx5LlxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqL1xuICBmb3JlZ3JvdW5kQ2xvc2luZyQ6IE9ic2VydmFibGU8U2hvd0V2ZW50PjtcblxuICAvKipcbiAgICogRm9yIGludGVybmFsIHVzZSBvbmx5LlxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqL1xuICBzaG93QmFja2dyb3VuZCQ6IE9ic2VydmFibGU8U2hvd0V2ZW50PjtcblxuICAvKipcbiAgICogRm9yIGludGVybmFsIHVzZSBvbmx5LlxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqL1xuICBzaG93Rm9yZWdyb3VuZCQ6IE9ic2VydmFibGU8U2hvd0V2ZW50PjtcblxuICBwcml2YXRlIGJnQ2xvc2luZzogQmVoYXZpb3JTdWJqZWN0PFNob3dFdmVudD47XG4gIHByaXZhdGUgZGVmYXVsdENvbmZpZzogTmd4VWlMb2FkZXJDb25maWc7XG4gIHByaXZhdGUgZmdDbG9zaW5nOiBCZWhhdmlvclN1YmplY3Q8U2hvd0V2ZW50PjtcbiAgcHJpdmF0ZSBsb2FkZXJzOiBMb2FkZXJzO1xuICBwcml2YXRlIHNob3dCYWNrZ3JvdW5kOiBCZWhhdmlvclN1YmplY3Q8U2hvd0V2ZW50PjtcbiAgcHJpdmF0ZSBzaG93Rm9yZWdyb3VuZDogQmVoYXZpb3JTdWJqZWN0PFNob3dFdmVudD47XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdG9yXG4gICAqL1xuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KE5HWF9VSV9MT0FERVJfQ09ORklHX1RPS0VOKSBwcml2YXRlIGNvbmZpZzogTmd4VWlMb2FkZXJDb25maWcpIHtcbiAgICB0aGlzLmRlZmF1bHRDb25maWcgPSB7IC4uLkRFRkFVTFRfQ09ORklHIH07XG4gICAgaWYgKHRoaXMuY29uZmlnKSB7XG4gICAgICBpZiAodGhpcy5jb25maWcubWluVGltZSAmJiB0aGlzLmNvbmZpZy5taW5UaW1lIDwgTUlOX1RJTUUpIHtcbiAgICAgICAgdGhpcy5jb25maWcubWluVGltZSA9IE1JTl9USU1FO1xuICAgICAgfVxuICAgICAgdGhpcy5kZWZhdWx0Q29uZmlnID0geyAuLi50aGlzLmRlZmF1bHRDb25maWcsIC4uLnRoaXMuY29uZmlnIH07XG4gICAgfVxuICAgIHRoaXMubG9hZGVycyA9IHt9O1xuICAgIHRoaXMuc2hvd0ZvcmVncm91bmQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFNob3dFdmVudD4oeyBsb2FkZXJJZDogJycsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgdGhpcy5zaG93Rm9yZWdyb3VuZCQgPSB0aGlzLnNob3dGb3JlZ3JvdW5kLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuc2hvd0JhY2tncm91bmQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFNob3dFdmVudD4oeyBsb2FkZXJJZDogJycsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgdGhpcy5zaG93QmFja2dyb3VuZCQgPSB0aGlzLnNob3dCYWNrZ3JvdW5kLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuZmdDbG9zaW5nID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTaG93RXZlbnQ+KHsgbG9hZGVySWQ6ICcnLCBpc1Nob3c6IGZhbHNlIH0pO1xuICAgIHRoaXMuZm9yZWdyb3VuZENsb3NpbmckID0gdGhpcy5mZ0Nsb3NpbmcuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5iZ0Nsb3NpbmcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFNob3dFdmVudD4oeyBsb2FkZXJJZDogJycsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgdGhpcy5iYWNrZ3JvdW5kQ2xvc2luZyQgPSB0aGlzLmJnQ2xvc2luZy5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuXG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICovXG4gIGJpbmRMb2FkZXJEYXRhKGxvYWRlcklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBpc01hc3RlciA9IGxvYWRlcklkID09PSB0aGlzLmRlZmF1bHRDb25maWcubWFzdGVyTG9hZGVySWQ7XG4gICAgaWYgKHRoaXMubG9hZGVyc1tsb2FkZXJJZF0pIHtcbiAgICAgIGlmICh0aGlzLmxvYWRlcnNbbG9hZGVySWRdLmlzQm91bmQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbbmd4LXVpLWxvYWRlcl0gLSBsb2FkZXJJZCBcIiR7bG9hZGVySWR9XCIgaXMgZHVwbGljYXRlZC5gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9hZGVyc1tsb2FkZXJJZF0uaXNCb3VuZCA9IHRydWU7XG4gICAgICB0aGlzLmxvYWRlcnNbbG9hZGVySWRdLmlzTWFzdGVyID0gaXNNYXN0ZXI7XG4gICAgICAvLyBlbWl0IHNob3dFdmVudCBhZnRlciBkYXRhIGxvYWRlciBpcyBib3VuZFxuICAgICAgaWYgKHRoaXMuaGFzUnVubmluZ1Rhc2soRk9SRUdST1VORCwgbG9hZGVySWQpKSB7XG4gICAgICAgIHRoaXMuc2hvd0ZvcmVncm91bmQubmV4dCh7IGxvYWRlcklkLCBpc1Nob3c6IHRydWUgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5oYXNSdW5uaW5nVGFzayhCQUNLR1JPVU5ELCBsb2FkZXJJZCkpIHtcbiAgICAgICAgICB0aGlzLnNob3dCYWNrZ3JvdW5kLm5leHQoeyBsb2FkZXJJZCwgaXNTaG93OiB0cnVlIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlTG9hZGVyRGF0YShsb2FkZXJJZCwgaXNNYXN0ZXIsIHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuXG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICovXG4gIGRlc3Ryb3lMb2FkZXJEYXRhKGxvYWRlcklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BBbGxMb2FkZXIobG9hZGVySWQpO1xuICAgIGRlbGV0ZSB0aGlzLmxvYWRlcnNbbG9hZGVySWRdO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkZWZhdWx0IGxvYWRlciBjb25maWd1cmF0aW9uXG4gICAqIEByZXR1cm5zIGRlZmF1bHQgY29uZmlndXJhdGlvbiBvYmplY3RcbiAgICovXG4gIGdldERlZmF1bHRDb25maWcoKTogTmd4VWlMb2FkZXJDb25maWcge1xuICAgIHJldHVybiB7IC4uLnRoaXMuZGVmYXVsdENvbmZpZyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbGwgdGhlIGxvYWRlcnNcbiAgICovXG4gIGdldExvYWRlcnMoKTogTG9hZGVycyB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5sb2FkZXJzKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRhdGEgb2YgYSBzcGVjaWZpZWQgbG9hZGVyLiBJZiBsb2FkZXJJZCBpcyBub3QgcHJvdmlkZWQsIGl0IHdpbGwgcmV0dXJuIGRhdGEgb2ZcbiAgICogbWFzdGVyIGxvYWRlcihpZiBleGlzdGVkKS4gT3RoZXJ3aXNlIG51bGwgaXMgcmV0dXJuZWQuXG4gICAqL1xuICBnZXRMb2FkZXIobG9hZGVySWQ/OiBzdHJpbmcpOiBMb2FkZXIge1xuICAgIGxvYWRlcklkID0gbG9hZGVySWQgPyBsb2FkZXJJZCA6IHRoaXMuZGVmYXVsdENvbmZpZy5tYXN0ZXJMb2FkZXJJZDtcbiAgICBpZiAodGhpcy5sb2FkZXJzW2xvYWRlcklkXSkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5sb2FkZXJzW2xvYWRlcklkXSkpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgZm9yZWdyb3VuZCBsb2FkaW5nIG9mIGxvYWRlciBoYXZpbmcgYGxvYWRlcklkYCB3aXRoIGEgc3BlY2lmaWVkIGB0YXNrSWRgLlxuICAgKiBUaGUgbG9hZGluZyBpcyBvbmx5IGNsb3NlZCBvZmYgd2hlbiBhbGwgdGFza0lkcyBvZiB0aGF0IGxvYWRlciBhcmUgY2FsbGVkIHdpdGggc3RvcExvYWRlcigpIG1ldGhvZC5cbiAgICogQHBhcmFtIGxvYWRlcklkIHRoZSBsb2FkZXIgSWRcbiAgICogQHBhcmFtIHRhc2tJZCB0aGUgb3B0aW9uYWwgdGFzayBJZCBvZiB0aGUgbG9hZGluZy4gdGFza0lkIGlzIHNldCB0byAnZmQtZGVmYXVsdCcgYnkgZGVmYXVsdC5cbiAgICovXG4gIHN0YXJ0TG9hZGVyKGxvYWRlcklkOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nID0gREVGQVVMVF9GR19UQVNLX0lELCB0aW1lPzogVGltZSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5yZWFkeVRvU3RhcnQobG9hZGVySWQsIHRhc2tJZCwgdHJ1ZSwgdGltZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmxvYWRlcnNbbG9hZGVySWRdLnRhc2tzW3Rhc2tJZF0uaXNPdGhlclJ1bm5pbmcpIHtcbiAgICAgIC8vIG5vIG90aGVyIGZvcmVncm91bmQgdGFzayBydW5uaW5nXG4gICAgICBpZiAodGhpcy5oYXNSdW5uaW5nVGFzayhCQUNLR1JPVU5ELCBsb2FkZXJJZCkpIHtcbiAgICAgICAgdGhpcy5iYWNrZ3JvdW5kQ2xvc2VvdXQobG9hZGVySWQpO1xuICAgICAgICB0aGlzLnNob3dCYWNrZ3JvdW5kLm5leHQoeyBsb2FkZXJJZCwgaXNTaG93OiBmYWxzZSB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2hvd0ZvcmVncm91bmQubmV4dCh7IGxvYWRlcklkLCBpc1Nob3c6IHRydWUgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IHRoZSBmb3JlZ3JvdW5kIGxvYWRpbmcgb2YgbWFzdGVyIGxvYWRlciB3aXRoIGEgc3BlY2lmaWVkIGB0YXNrSWRgLlxuICAgKiBUaGUgbG9hZGluZyBpcyBvbmx5IGNsb3NlZCBvZmYgd2hlbiBhbGwgdGFza0lkcyBvZiB0aGF0IGxvYWRlciBhcmUgY2FsbGVkIHdpdGggc3RvcCgpIG1ldGhvZC5cbiAgICogTk9URTogUmVhbGx5IHRoaXMgZnVuY3Rpb24ganVzdCB3cmFwcyBzdGFydExvYWRlcigpIGZ1bmN0aW9uXG4gICAqIEBwYXJhbSB0YXNrSWQgdGhlIG9wdGlvbmFsIHRhc2sgSWQgb2YgdGhlIGxvYWRpbmcuIHRhc2tJZCBpcyBzZXQgdG8gJ2ZkLWRlZmF1bHQnIGJ5IGRlZmF1bHQuXG4gICAqL1xuICBzdGFydCh0YXNrSWQ6IHN0cmluZyA9IERFRkFVTFRfRkdfVEFTS19JRCwgdGltZT86IFRpbWUpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXJ0TG9hZGVyKHRoaXMuZGVmYXVsdENvbmZpZy5tYXN0ZXJMb2FkZXJJZCwgdGFza0lkLCB0aW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgYmFja2dyb3VuZCBsb2FkaW5nIG9mIGxvYWRlciBoYXZpbmcgYGxvYWRlcklkYCB3aXRoIGEgc3BlY2lmaWVkIGB0YXNrSWRgLlxuICAgKiBUaGUgbG9hZGluZyBpcyBvbmx5IGNsb3NlZCBvZmYgd2hlbiBhbGwgdGFza0lkcyBvZiB0aGF0IGxvYWRlciBhcmUgY2FsbGVkIHdpdGggc3RvcExvYWRlckJhY2tncm91bmQoKSBtZXRob2QuXG4gICAqIEBwYXJhbSBsb2FkZXJJZCB0aGUgbG9hZGVyIElkXG4gICAqIEBwYXJhbSB0YXNrSWQgdGhlIG9wdGlvbmFsIHRhc2sgSWQgb2YgdGhlIGxvYWRpbmcuIHRhc2tJZCBpcyBzZXQgdG8gJ2JnLWRlZmF1bHQnIGJ5IGRlZmF1bHQuXG4gICAqL1xuICBzdGFydEJhY2tncm91bmRMb2FkZXIobG9hZGVySWQ6IHN0cmluZywgdGFza0lkOiBzdHJpbmcgPSBERUZBVUxUX0JHX1RBU0tfSUQsIHRpbWU/OiBUaW1lKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnJlYWR5VG9TdGFydChsb2FkZXJJZCwgdGFza0lkLCBmYWxzZSwgdGltZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmhhc1J1bm5pbmdUYXNrKEZPUkVHUk9VTkQsIGxvYWRlcklkKSAmJiAhdGhpcy5sb2FkZXJzW2xvYWRlcklkXS50YXNrc1t0YXNrSWRdLmlzT3RoZXJSdW5uaW5nKSB7XG4gICAgICB0aGlzLnNob3dCYWNrZ3JvdW5kLm5leHQoeyBsb2FkZXJJZCwgaXNTaG93OiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgYmFja2dyb3VuZCBsb2FkaW5nIG9mIG1hc3RlciBsb2FkZXIgd2l0aCBhIHNwZWNpZmllZCBgdGFza0lkYC5cbiAgICogVGhlIGxvYWRpbmcgaXMgb25seSBjbG9zZWQgb2ZmIHdoZW4gYWxsIHRhc2tJZHMgb2YgdGhhdCBsb2FkZXIgYXJlIGNhbGxlZCB3aXRoIHN0b3BCYWNrZ3JvdW5kKCkgbWV0aG9kLlxuICAgKiBOT1RFOiBSZWFsbHkgdGhpcyBmdW5jdGlvbiBqdXN0IHdyYXBzIHN0YXJ0QmFja2dyb3VuZExvYWRlcigpIGZ1bmN0aW9uXG4gICAqIEBwYXJhbSB0YXNrSWQgdGhlIG9wdGlvbmFsIHRhc2sgSWQgb2YgdGhlIGxvYWRpbmcuIHRhc2tJZCBpcyBzZXQgdG8gJ2JnLWRlZmF1bHQnIGJ5IGRlZmF1bHQuXG4gICAqL1xuICBzdGFydEJhY2tncm91bmQodGFza0lkOiBzdHJpbmcgPSBERUZBVUxUX0JHX1RBU0tfSUQsIHRpbWU/OiBUaW1lKTogdm9pZCB7XG4gICAgdGhpcy5zdGFydEJhY2tncm91bmRMb2FkZXIodGhpcy5kZWZhdWx0Q29uZmlnLm1hc3RlckxvYWRlcklkLCB0YXNrSWQsIHRpbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgYSBmb3JlZ3JvdW5kIGxvYWRpbmcgb2YgbG9hZGVyIGhhdmluZyBgbG9hZGVySWRgIHdpdGggc3BlY2lmaWMgYHRhc2tJZGBcbiAgICogQHBhcmFtIGxvYWRlcklkIHRoZSBsb2FkZXIgSWRcbiAgICogQHBhcmFtIHRhc2tJZCB0aGUgb3B0aW9uYWwgdGFzayBJZCB0byBzdG9wLiBJZiBub3QgcHJvdmlkZWQsICdmZy1kZWZhdWx0JyBpcyB1c2VkLlxuICAgKiBAcmV0dXJucyBPYmplY3RcbiAgICovXG4gIHN0b3BMb2FkZXIobG9hZGVySWQ6IHN0cmluZywgdGFza0lkOiBzdHJpbmcgPSBERUZBVUxUX0ZHX1RBU0tfSUQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucmVhZHlUb1N0b3AobG9hZGVySWQsIHRhc2tJZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmhhc1J1bm5pbmdUYXNrKEZPUkVHUk9VTkQsIGxvYWRlcklkKSkge1xuICAgICAgdGhpcy5mb3JlZ3JvdW5kQ2xvc2VvdXQobG9hZGVySWQpO1xuICAgICAgdGhpcy5zaG93Rm9yZWdyb3VuZC5uZXh0KHsgbG9hZGVySWQsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgICBpZiAodGhpcy5oYXNSdW5uaW5nVGFzayhCQUNLR1JPVU5ELCBsb2FkZXJJZCkpIHtcbiAgICAgICAgc2V0VGltZW91dChcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5oYXNSdW5uaW5nVGFzayhCQUNLR1JPVU5ELCBsb2FkZXJJZCkpIHtcbiAgICAgICAgICAgICAgLy8gc3RpbGwgaGF2ZSBiYWNrZ3JvdW5kIHRhc2tzXG4gICAgICAgICAgICAgIHRoaXMuc2hvd0JhY2tncm91bmQubmV4dCh7IGxvYWRlcklkLCBpc1Nob3c6IHRydWUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aGlzLmRlZmF1bHRDb25maWcuZmFzdEZhZGVPdXQgPyBGQVNUX09WRVJMQVlfRElTQVBQRUFSX1RJTUUgOiBPVkVSTEFZX0RJU0FQUEVBUl9USU1FXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgYSBmb3JlZ3JvdW5kIGxvYWRpbmcgb2YgbWFzdGVyIGxvYWRlciB3aXRoIHNwZWNpZmljIGB0YXNrSWRgXG4gICAqIEBwYXJhbSB0YXNrSWQgdGhlIG9wdGlvbmFsIHRhc2sgSWQgdG8gc3RvcC4gSWYgbm90IHByb3ZpZGVkLCAnZmctZGVmYXVsdCcgaXMgdXNlZC5cbiAgICogQHJldHVybnMgT2JqZWN0XG4gICAqL1xuICBzdG9wKHRhc2tJZDogc3RyaW5nID0gREVGQVVMVF9GR19UQVNLX0lEKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wTG9hZGVyKHRoaXMuZGVmYXVsdENvbmZpZy5tYXN0ZXJMb2FkZXJJZCwgdGFza0lkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIGEgYmFja2dyb3VuZCBsb2FkaW5nIG9mIGxvYWRlciBoYXZpbmcgYGxvYWRlcklkYCB3aXRoIHNwZWNpZmljIGB0YXNrSWRgXG4gICAqIEBwYXJhbSBsb2FkZXJJZCB0aGUgbG9hZGVyIElkXG4gICAqIEBwYXJhbSB0YXNrSWQgdGhlIG9wdGlvbmFsIHRhc2sgSWQgdG8gc3RvcC4gSWYgbm90IHByb3ZpZGVkLCAnYmctZGVmYXVsdCcgaXMgdXNlZC5cbiAgICogQHJldHVybnMgT2JqZWN0XG4gICAqL1xuICBzdG9wQmFja2dyb3VuZExvYWRlcihsb2FkZXJJZDogc3RyaW5nLCB0YXNrSWQ6IHN0cmluZyA9IERFRkFVTFRfQkdfVEFTS19JRCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5yZWFkeVRvU3RvcChsb2FkZXJJZCwgdGFza0lkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuaGFzUnVubmluZ1Rhc2soRk9SRUdST1VORCwgbG9hZGVySWQpICYmICF0aGlzLmhhc1J1bm5pbmdUYXNrKEJBQ0tHUk9VTkQsIGxvYWRlcklkKSkge1xuICAgICAgdGhpcy5iYWNrZ3JvdW5kQ2xvc2VvdXQobG9hZGVySWQpO1xuICAgICAgdGhpcy5zaG93QmFja2dyb3VuZC5uZXh0KHsgbG9hZGVySWQsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgYSBiYWNrZ3JvdW5kIGxvYWRpbmcgb2YgbWFzdGVyIGxvYWRlciB3aXRoIHNwZWNpZmljIHRhc2tJZFxuICAgKiBAcGFyYW0gdGFza0lkIHRoZSBvcHRpb25hbCB0YXNrIElkIHRvIHN0b3AuIElmIG5vdCBwcm92aWRlZCwgJ2JnLWRlZmF1bHQnIGlzIHVzZWQuXG4gICAqIEByZXR1cm5zIE9iamVjdFxuICAgKi9cbiAgc3RvcEJhY2tncm91bmQodGFza0lkOiBzdHJpbmcgPSBERUZBVUxUX0JHX1RBU0tfSUQpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BCYWNrZ3JvdW5kTG9hZGVyKHRoaXMuZGVmYXVsdENvbmZpZy5tYXN0ZXJMb2FkZXJJZCwgdGFza0lkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIGFsbCB0aGUgYmFja2dyb3VuZCBhbmQgZm9yZWdyb3VuZCBsb2FkaW5ncyBvZiBsb2FkZXIgaGF2aW5nIGBsb2FkZXJJZGBcbiAgICogQHBhcmFtIGxvYWRlcklkIHRoZSBsb2FkZXIgSWRcbiAgICovXG4gIHN0b3BBbGxMb2FkZXIobG9hZGVySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghdGhpcy5sb2FkZXJzW2xvYWRlcklkXSkge1xuICAgICAgY29uc29sZS53YXJuKGBbbmd4LXVpLWxvYWRlcl0gLSBsb2FkZXJJZCBcIiR7bG9hZGVySWR9XCIgZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLmhhc1J1bm5pbmdUYXNrKEZPUkVHUk9VTkQsIGxvYWRlcklkKSkge1xuICAgICAgdGhpcy5mb3JlZ3JvdW5kQ2xvc2VvdXQobG9hZGVySWQpO1xuICAgICAgdGhpcy5zaG93Rm9yZWdyb3VuZC5uZXh0KHsgbG9hZGVySWQsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmhhc1J1bm5pbmdUYXNrKEJBQ0tHUk9VTkQsIGxvYWRlcklkKSkge1xuICAgICAgdGhpcy5iYWNrZ3JvdW5kQ2xvc2VvdXQobG9hZGVySWQpO1xuICAgICAgdGhpcy5zaG93QmFja2dyb3VuZC5uZXh0KHsgbG9hZGVySWQsIGlzU2hvdzogZmFsc2UgfSk7XG4gICAgfVxuICAgIHRoaXMuY2xlYXJBbGxUaW1lcnModGhpcy5sb2FkZXJzW2xvYWRlcklkXS50YXNrcyk7XG4gICAgdGhpcy5sb2FkZXJzW2xvYWRlcklkXS50YXNrcyA9IHt9O1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgYWxsIHRoZSBiYWNrZ3JvdW5kIGFuZCBmb3JlZ3JvdW5kIGxvYWRpbmdzIG9mIG1hc3RlciBsb2FkZXJcbiAgICovXG4gIHN0b3BBbGwoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wQWxsTG9hZGVyKHRoaXMuZGVmYXVsdENvbmZpZy5tYXN0ZXJMb2FkZXJJZCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGxvYWRlciBkYXRhIGlmIGl0IGRvZXMgbm90IGV4aXN0XG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlTG9hZGVyRGF0YShsb2FkZXJJZDogc3RyaW5nLCBpc01hc3RlcjogYm9vbGVhbiwgaXNCb3VuZDogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICghdGhpcy5sb2FkZXJzW2xvYWRlcklkXSkge1xuICAgICAgdGhpcy5sb2FkZXJzW2xvYWRlcklkXSA9IHtcbiAgICAgICAgbG9hZGVySWQsXG4gICAgICAgIHRhc2tzOiB7fSxcbiAgICAgICAgaXNNYXN0ZXIsXG4gICAgICAgIGlzQm91bmRcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE1hbmFnZSB0byBjbG9zZSBmb3JlZ3JvdW5kIGxvYWRpbmdcbiAgICogQGRvY3MtcHJpdmF0ZVxuICAgKiBAcGFyYW0gbG9hZGVySWQgdGhlIGxvYWRlciBpZFxuICAgKi9cbiAgcHJpdmF0ZSBmb3JlZ3JvdW5kQ2xvc2VvdXQobG9hZGVySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuZmdDbG9zaW5nLm5leHQoeyBsb2FkZXJJZCwgaXNTaG93OiB0cnVlIH0pO1xuICAgIHNldFRpbWVvdXQoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHRoaXMuZmdDbG9zaW5nLm5leHQoeyBsb2FkZXJJZCwgaXNTaG93OiBmYWxzZSB9KTtcbiAgICAgIH0sXG4gICAgICB0aGlzLmRlZmF1bHRDb25maWcuZmFzdEZhZGVPdXQgPyBGQVNUX0NMT1NJTkdfVElNRSA6IENMT1NJTkdfVElNRVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogTWFuYWdlIHRvIGNsb3NlIGJhY2tncm91bmQgbG9hZGluZ1xuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqIEBwYXJhbSBsb2FkZXJJZCB0aGUgbG9hZGVyIGlkXG4gICAqL1xuICBwcml2YXRlIGJhY2tncm91bmRDbG9zZW91dChsb2FkZXJJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5iZ0Nsb3NpbmcubmV4dCh7IGxvYWRlcklkLCBpc1Nob3c6IHRydWUgfSk7XG4gICAgc2V0VGltZW91dChcbiAgICAgICgpID0+IHtcbiAgICAgICAgdGhpcy5iZ0Nsb3NpbmcubmV4dCh7IGxvYWRlcklkLCBpc1Nob3c6IGZhbHNlIH0pO1xuICAgICAgfSxcbiAgICAgIHRoaXMuZGVmYXVsdENvbmZpZy5mYXN0RmFkZU91dCA/IEZBU1RfQ0xPU0lOR19USU1FIDogQ0xPU0lOR19USU1FXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgdGltZXJzIG9mIHRoZSBnaXZlbiB0YXNrXG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgY2xlYXJUaW1lcnModGFzazogVGFzayk6IHZvaWQge1xuICAgIGNsZWFyVGltZW91dCh0YXNrLmRlbGF5VGltZXIpO1xuICAgIGNsZWFyVGltZW91dCh0YXNrLm1heFRpbWVyKTtcbiAgICBjbGVhclRpbWVvdXQodGFzay5taW5UaW1lcik7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIHRpbWVycyBvZiB0aGUgZ2l2ZW4gdGFza3NcbiAgICogQGRvY3MtcHJpdmF0ZVxuICAgKi9cbiAgcHJpdmF0ZSBjbGVhckFsbFRpbWVycyh0YXNrczogVGFza3MpOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyh0YXNrcykubWFwKGlkID0+IHtcbiAgICAgIHRoaXMuY2xlYXJUaW1lcnModGFza3NbaWRdKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgbG9hZGVyIGhhcyBhIHJ1bm5pbmcgdGFzayB3aXRoIHRoZSBnaXZlbiBgdGFza0lkYC5cbiAgICogSWYgbm8gYHRhc2tJZGAgc3BlY2lmaWVkLCBpdCB3aWxsIGNoZWNrIHdoZXRoZXIgdGhlIGxvYWRlciBoYXMgYW55IHJ1bm5pbmcgdGFza3MuXG4gICAqIEZvciBpbnRlcm5hbCB1c2Ugb25seS5cbiAgICogQGRvY3MtcHJpdmF0ZVxuICAgKiBAcGFyYW0gaXNGb3JlZ3JvdW5kIGZvcmVncm91bmQgdGFzayBvciBiYWNrZ3JvdW5kIHRhc2tcbiAgICogQHBhcmFtIGxvYWRlcklkIHRoZSBsb2FkZXIgSWRcbiAgICogQHBhcmFtIHRhc2tJZCB0aGUgb3B0aW9uYWwgdGFzayBJZFxuICAgKiBAcmV0dXJucyBib29sZWFuXG4gICAqL1xuICBoYXNSdW5uaW5nVGFzayhpc0ZvcmVncm91bmQ6IGJvb2xlYW4sIGxvYWRlcklkOiBzdHJpbmcsIHRhc2tJZD86IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLmxvYWRlcnNbbG9hZGVySWRdKSB7XG4gICAgICBjb25zdCB0YXNrczogVGFza3MgPSB0aGlzLmxvYWRlcnNbbG9hZGVySWRdLnRhc2tzO1xuICAgICAgaWYgKHRhc2tJZCkge1xuICAgICAgICByZXR1cm4gdGFza3NbdGFza0lkXSA/ICh0YXNrc1t0YXNrSWRdLnN0YXJ0QXQgPyB0cnVlIDogZmFsc2UpIDogZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gT2JqZWN0LmtleXModGFza3MpLnNvbWUoaWQgPT4gISF0YXNrc1tpZF0uc3RhcnRBdCAmJiB0YXNrc1tpZF0uaXNGb3JlZ3JvdW5kID09PSBpc0ZvcmVncm91bmQpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQGRvY3MtcHJpdmF0ZVxuICAgKi9cbiAgcHJpdmF0ZSByZWFkeVRvU3RhcnQobG9hZGVySWQ6IHN0cmluZywgdGFza0lkOiBzdHJpbmcsIGlzRm9yZWdyb3VuZDogYm9vbGVhbiwgdGltZTogVGltZSA9IERFRkFVTFRfVElNRSk6IGJvb2xlYW4ge1xuICAgIHRoaXMuY3JlYXRlTG9hZGVyRGF0YShsb2FkZXJJZCwgdW5kZWZpbmVkLCBmYWxzZSk7XG4gICAgY29uc3QgaXNPdGhlclJ1bm5pbmcgPSB0aGlzLmhhc1J1bm5pbmdUYXNrKGlzRm9yZWdyb3VuZCwgbG9hZGVySWQpO1xuICAgIGlmICghdGhpcy5sb2FkZXJzW2xvYWRlcklkXS50YXNrc1t0YXNrSWRdKSB7XG4gICAgICB0aGlzLmxvYWRlcnNbbG9hZGVySWRdLnRhc2tzW3Rhc2tJZF0gPSB7XG4gICAgICAgIHRhc2tJZCxcbiAgICAgICAgaXNGb3JlZ3JvdW5kLFxuICAgICAgICBtaW5UaW1lOiB0aW1lLm1pblRpbWUgPj0gTUlOX1RJTUUgPyB0aW1lLm1pblRpbWUgOiB0aGlzLmRlZmF1bHRDb25maWcubWluVGltZSxcbiAgICAgICAgbWF4VGltZTogdGltZS5tYXhUaW1lID8gdGltZS5tYXhUaW1lIDogdGhpcy5kZWZhdWx0Q29uZmlnLm1heFRpbWUsXG4gICAgICAgIGRlbGF5OiB0aW1lLmRlbGF5ID49IE1JTl9ERUxBWSA/IHRpbWUuZGVsYXkgOiB0aGlzLmRlZmF1bHRDb25maWcuZGVsYXlcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmxvYWRlcnNbbG9hZGVySWRdLnRhc2tzW3Rhc2tJZF0uaXNGb3JlZ3JvdW5kICE9PSBpc0ZvcmVncm91bmQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbbmd4LXVpLWxvYWRlcl0gLSB0YXNrSWQgXCIke3Rhc2tJZH1cIiBpcyBkdXBsaWNhdGVkLmApO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5zZXREZWxheVRpbWVyKHRoaXMubG9hZGVyc1tsb2FkZXJJZF0udGFza3NbdGFza0lkXSwgbG9hZGVySWQpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMubG9hZGVyc1tsb2FkZXJJZF0udGFza3NbdGFza0lkXSA9IHtcbiAgICAgIC4uLnRoaXMubG9hZGVyc1tsb2FkZXJJZF0udGFza3NbdGFza0lkXSxcbiAgICAgIGlzT3RoZXJSdW5uaW5nLFxuICAgICAgc3RhcnRBdDogRGF0ZS5ub3coKVxuICAgIH07XG4gICAgdGhpcy5zZXRNYXhUaW1lcih0aGlzLmxvYWRlcnNbbG9hZGVySWRdLnRhc2tzW3Rhc2tJZF0sIGxvYWRlcklkKTtcbiAgICBpZiAoIXRoaXMubG9hZGVyc1tsb2FkZXJJZF0uaXNCb3VuZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqL1xuICBwcml2YXRlIHJlYWR5VG9TdG9wKGxvYWRlcklkOiBzdHJpbmcsIHRhc2tJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLmxvYWRlcnNbbG9hZGVySWRdKSB7XG4gICAgICBjb25zb2xlLndhcm4oYFtuZ3gtdWktbG9hZGVyXSAtIGxvYWRlcklkIFwiJHtsb2FkZXJJZH1cIiBkb2VzIG5vdCBleGlzdC5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgdGFzazogVGFzayA9IHRoaXMubG9hZGVyc1tsb2FkZXJJZF0udGFza3NbdGFza0lkXTtcbiAgICBpZiAoIXRhc2spIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHRhc2suaXNEZWxheWVkKSB7XG4gICAgICB0aGlzLmNsZWFyVGltZXJzKHRhc2spO1xuICAgICAgZGVsZXRlIHRoaXMubG9hZGVyc1tsb2FkZXJJZF0udGFza3NbdGFza0lkXTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc2V0TWluVGltZXIodGFzaywgbG9hZGVySWQpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuY2xlYXJUaW1lcnModGFzayk7XG4gICAgZGVsZXRlIHRoaXMubG9hZGVyc1tsb2FkZXJJZF0udGFza3NbdGFza0lkXTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgZGVsYXkgdGltZXIsIGlmIGBkZWxheWAgPiAwXG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICogQHJldHVybnMgYm9vbGVhblxuICAgKi9cbiAgcHJpdmF0ZSBzZXREZWxheVRpbWVyKHRhc2s6IFRhc2ssIGxvYWRlcklkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAodGFzay5kZWxheSA+IE1JTl9ERUxBWSkge1xuICAgICAgaWYgKHRhc2suaXNEZWxheWVkKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKCF0YXNrLmRlbGF5VGltZXIpIHtcbiAgICAgICAgdGFzay5pc0RlbGF5ZWQgPSB0cnVlO1xuICAgICAgICB0YXNrLmRlbGF5VGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0YXNrLmlzRGVsYXllZCA9IGZhbHNlO1xuICAgICAgICAgIGlmICh0YXNrLmlzRm9yZWdyb3VuZCkge1xuICAgICAgICAgICAgdGhpcy5zdGFydExvYWRlcihsb2FkZXJJZCwgdGFzay50YXNrSWQpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0QmFja2dyb3VuZExvYWRlcihsb2FkZXJJZCwgdGFzay50YXNrSWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgdGFzay5kZWxheSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogU2V0IG1heFRpbWVyIGlmIGBtYXhUaW1lYCA+IGBtaW5UaW1lYFxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqIEByZXR1cm5zIGJvb2xlYW5cbiAgICovXG4gIHByaXZhdGUgc2V0TWF4VGltZXIodGFzazogVGFzaywgbG9hZGVySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0YXNrLm1heFRpbWUgPiB0YXNrLm1pblRpbWUpIHtcbiAgICAgIC8vIHJlc3RhcnQgdGhlIHRhc2ssIHJlc2V0IG1heFRpbWVyXG4gICAgICBjbGVhclRpbWVvdXQodGFzay5tYXhUaW1lcik7XG4gICAgICB0YXNrLm1heFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmICh0YXNrLmlzRm9yZWdyb3VuZCkge1xuICAgICAgICAgIHRoaXMuc3RvcExvYWRlcihsb2FkZXJJZCwgdGFzay50YXNrSWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuc3RvcEJhY2tncm91bmRMb2FkZXIobG9hZGVySWQsIHRhc2sudGFza0lkKTtcbiAgICAgICAgfVxuICAgICAgfSwgdGFzay5tYXhUaW1lKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IG1pblRpbWVyIGlmIGBzdGFydEF0YCArIGBtaW5UaW1lYCA+IGBEYXRlLm5vdygpYFxuICAgKiBAZG9jcy1wcml2YXRlXG4gICAqIEByZXR1cm5zIGJvb2xlYW5cbiAgICovXG4gIHByaXZhdGUgc2V0TWluVGltZXIodGFzazogVGFzaywgbG9hZGVySWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgaWYgKHRhc2suc3RhcnRBdCkge1xuICAgICAgaWYgKHRhc2suc3RhcnRBdCArIHRhc2subWluVGltZSA+IG5vdykge1xuICAgICAgICB0YXNrLm1pblRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRhc2suaXNGb3JlZ3JvdW5kKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3BMb2FkZXIobG9hZGVySWQsIHRhc2sudGFza0lkKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdG9wQmFja2dyb3VuZExvYWRlcihsb2FkZXJJZCwgdGFzay50YXNrSWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgdGFzay5zdGFydEF0ICsgdGFzay5taW5UaW1lIC0gbm93KTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuIl19